rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email == email;
    }
    
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    function hasAccess() {
      return isAuthenticated() && request.auth.token.hasAccess == true;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    // ============ PUBLIC ACCESS (Marketing Content) ============
    // Anyone can read marketing content - homepage, samples, pricing
    match /content/{document=**} {
      allow read: if true;  // Public marketing content
      allow write: if isAdmin(); // Only admins can update marketing
    }
    
    // ============ AUTHENTICATED ACCESS ============
    // User profiles - users can only access their own data
    match /users/{email} {
      allow read, write: if isOwner(email);
      allow read: if isAdmin(); // Admins can read all user profiles
    }
    
    // User-generated content - users can only access their own
    match /userProfiles/{email} {
      allow read, write: if isOwner(email);
      allow read: if isAdmin(); // Admins can read for support
      
      // Student profiles subcollection
      match /studentProfiles/{profileId} {
        allow read, write: if isOwner(email);
        allow read: if isAdmin();
      }
      
      // Generated letters subcollection  
      match /generatedLetters/{letterId} {
        allow read, write: if isOwner(email);
        allow read: if isAdmin();
      }
      
      // Saved templates subcollection
      match /savedTemplates/{templateId} {
        allow read, write: if isOwner(email);
        allow read: if isAdmin();
      }
    }
    
    // ============ PREMIUM ACCESS (Paid Content) ============
    // Premium content requires payment verification via custom claims
    match /premiumContent/{document=**} {
      allow read: if hasAccess(); // Must have paid access
      allow write: if isAdmin(); // Only admins can update premium content
    }
    
    // ============ SUBSCRIPTION & PAYMENT DATA ============
    // Server-only access for sensitive data
    match /subscriptions/{email} {
      allow read: if isOwner(email) || isAdmin(); // Users can read their own subscription
      allow write: if false; // Only server via Admin SDK
    }
    
    match /payments/{email} {
      allow read: if isOwner(email) || isAdmin(); // Users can read their payment history
      allow write: if false; // Only server via Admin SDK
    }
    
    // ============ SYSTEM CONFIGURATION ============
    match /system/{document=**} {
      allow read: if isAdmin(); // Admins can read system config
      allow write: if false; // Only server via Admin SDK
    }
    
    // ============ ADMIN PANEL ACCESS ============
    // Special admin-only collections for management
    match /adminLogs/{document=**} {
      allow read, write: if isAdmin();
    }
    
    match /analytics/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // ============ FALLBACK SECURITY ============
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
